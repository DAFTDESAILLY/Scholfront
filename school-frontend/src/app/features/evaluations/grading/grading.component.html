<div class="grading-container">
    <mat-card>
        <mat-card-header>
            <mat-card-title class="title-row">
                Calificaciones
                <app-help-icon
                    message="Asigna calificaciones a los estudiantes para cada evaluación y periodo académico."></app-help-icon>
            </mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <form [formGroup]="filterForm" class="filter-form">
                <mat-form-field appearance="outline">
                    <mat-label>Materia</mat-label>
                    <mat-select formControlName="subjectId">
                        <mat-option *ngFor="let subject of subjects" [value]="subject.id">
                            {{ subject.name }}
                        </mat-option>
                    </mat-select>
                    <mat-error *ngIf="filterForm.get('subjectId')?.hasError('required')">
                        Selecciona una materia
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Evaluación</mat-label>
                    <mat-select formControlName="evaluationId" [disabled]="!filterForm.get('subjectId')?.value">
                        <mat-option *ngFor="let evaluation of evaluations" [value]="evaluation.id">
                            {{ evaluation.name }} ({{ evaluation.type }})
                        </mat-option>
                    </mat-select>
                    <mat-error *ngIf="filterForm.get('evaluationId')?.hasError('required')">
                        Selecciona una evaluación
                    </mat-error>
                </mat-form-field>

                <button mat-raised-button color="primary" 
                        (click)="onLoadGrades()" 
                        [disabled]="filterForm.invalid || isLoading">
                    <mat-spinner diameter="20" *ngIf="isLoading" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    {{ isLoading ? 'Cargando...' : 'Cargar Calificaciones' }}
                </button>
            </form>

            <div *ngIf="isLoading" class="loading-container">
                <mat-spinner></mat-spinner>
                <p>Cargando estudiantes y calificaciones...</p>
            </div>

            <div *ngIf="!isLoading && gradingData.length > 0" class="grading-table">
                <table mat-table [dataSource]="gradingData">

                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef> Nombre del Estudiante </th>
                        <td mat-cell *matCellDef="let row"> 
                            {{row.studentName}}
                            <span class="grade-status" *ngIf="row.gradeId" title="Calificación guardada">✓</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="score">
                        <th mat-header-cell *matHeaderCellDef> Puntuación </th>
                        <td mat-cell *matCellDef="let row">
                            <mat-form-field appearance="outline" class="score-field">
                                <input matInput type="number" [(ngModel)]="row.score" 
                                       min="0" max="100" step="0.1"
                                       placeholder="0.0">
                            </mat-form-field>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="feedback">
                        <th mat-header-cell *matHeaderCellDef> Retroalimentación </th>
                        <td mat-cell *matCellDef="let row">
                            <mat-form-field appearance="outline" class="full-width">
                                <input matInput [(ngModel)]="row.feedback" 
                                       placeholder="Retroalimentación opcional"
                                       maxlength="500">
                            </mat-form-field>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <div class="actions">
                    <button mat-raised-button color="accent" 
                            (click)="saveGrades()"
                            [disabled]="isSaving">
                        <mat-spinner diameter="20" *ngIf="isSaving" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                        {{ isSaving ? 'Guardando...' : 'Guardar Calificaciones' }}
                    </button>
                </div>
            </div>

            <div *ngIf="!isLoading && gradingData.length === 0 && filterForm.valid" class="no-data">
                <p>No hay estudiantes para mostrar. Selecciona una materia y evaluación.</p>
            </div>
        </mat-card-content>
    </mat-card>
</div>