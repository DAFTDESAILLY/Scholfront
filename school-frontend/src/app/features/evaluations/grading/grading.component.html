<div class="grading-container">
    <mat-card>
        <mat-card-header>
            <mat-card-title class="title-row">
                Calificaciones
                <app-help-icon
                    message="Asigna calificaciones a los estudiantes para cada evaluación y periodo académico."></app-help-icon>
            </mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <form [formGroup]="filterForm" class="filter-form">
                <mat-form-field appearance="outline">
                    <mat-label>Materia</mat-label>
                    <mat-select formControlName="subjectId">
                        <mat-option *ngFor="let subject of subjects" [value]="subject.id">
                            {{ subject.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Evaluación</mat-label>
                    <mat-select formControlName="evaluationId">
                        <mat-option *ngFor="let evaluation of evaluations" [value]="evaluation.id">
                            {{ evaluation.name }} ({{ evaluation.type }})
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <button mat-raised-button color="primary" (click)="onLoadGrades()" [disabled]="filterForm.invalid || isLoading">
                    <span *ngIf="!isLoading">Cargar Calificaciones</span>
                    <span *ngIf="isLoading" class="loading-container">
                        <mat-spinner diameter="20"></mat-spinner>
                        Cargando...
                    </span>
                </button>
            </form>

            <div *ngIf="gradingData.length > 0" class="grading-table">
                <table mat-table [dataSource]="gradingData">

                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef> Nombre del Estudiante </th>
                        <td mat-cell *matCellDef="let row"> {{row.studentName}} </td>
                    </ng-container>

                    <ng-container matColumnDef="score">
                        <th mat-header-cell *matHeaderCellDef> Puntuación </th>
                        <td mat-cell *matCellDef="let row">
                            <mat-form-field appearance="outline" class="score-field">
                                <input matInput type="number" [(ngModel)]="row.score" min="0" max="100">
                            </mat-form-field>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="feedback">
                        <th mat-header-cell *matHeaderCellDef> Retroalimentación </th>
                        <td mat-cell *matCellDef="let row">
                            <mat-form-field appearance="outline" class="full-width">
                                <input matInput [(ngModel)]="row.feedback" placeholder="Retroalimentación opcional">
                            </mat-form-field>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef> Estado </th>
                        <td mat-cell *matCellDef="let row">
                            <span *ngIf="row.hasExistingGrade" class="grade-status">✓</span>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <div class="actions">
                    <button mat-raised-button color="accent" (click)="saveGrades()" [disabled]="isSaving">
                        <span *ngIf="!isSaving">Guardar Calificaciones</span>
                        <span *ngIf="isSaving" class="loading-container">
                            <mat-spinner diameter="20"></mat-spinner>
                            Guardando...
                        </span>
                    </button>
                </div>
            </div>
        </mat-card-content>
    </mat-card>
</div>