<div class="container">
    <mat-card>
        <mat-card-header>
            <mat-card-title>Consentimientos del Estudiante</mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <table mat-table [dataSource]="consents" class="mat-elevation-z2">
                <!-- Consent Type Column -->
                <ng-container matColumnDef="consentType">
                    <th mat-header-cell *matHeaderCellDef>Tipo de Consentimiento</th>
                    <td mat-cell *matCellDef="let consent">
                        <span *ngFor="let t of (consent.types || []); let last = last">
                            {{ t.name || t.recordType }}<span *ngIf="!last">, </span>
                        </span>
                        <span *ngIf="!consent.types?.length">N/A</span>
                    </td>
                </ng-container>

                <!-- Granted By Column -->
                <ng-container matColumnDef="grantedBy">
                    <th mat-header-cell *matHeaderCellDef>Otorgado Por (ID)</th>
                    <td mat-cell *matCellDef="let consent">{{ consent.fromUserId }}</td>
                </ng-container>

                <!-- Granted At Column -->
                <ng-container matColumnDef="grantedAt">
                    <th mat-header-cell *matHeaderCellDef>Fecha de Otorgamiento</th>
                    <td mat-cell *matCellDef="let consent">
                        {{ consent.createdAt | date:'dd/MM/yyyy' }}
                    </td>
                </ng-container>

                <!-- Expires At Column -->
                <ng-container matColumnDef="expiresAt">
                    <th mat-header-cell *matHeaderCellDef>Fecha de Expiración</th>
                    <td mat-cell *matCellDef="let consent">
                        {{ consent.expiresAt ? (consent.expiresAt | date:'dd/MM/yyyy') : 'Sin expiración' }}
                    </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Estado</th>
                    <td mat-cell *matCellDef="let consent">
                        <mat-chip [color]="getStatusColor(getConsentStatus(consent))">
                            {{ getConsentStatus(consent) === 'active' ? 'Activo' :
                            getConsentStatus(consent) === 'revoked' ? 'Revocado' : 'Expirado' }}
                        </mat-chip>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Acciones</th>
                    <td mat-cell *matCellDef="let consent">
                        <button mat-icon-button *ngIf="consent.isActive" (click)="revokeConsent(consent)"
                            matTooltip="Revocar consentimiento">
                            <mat-icon>block</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="deleteConsent(consent.id)" matTooltip="Eliminar">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <div *ngIf="consents.length === 0 && !isLoading" class="no-data">
                No hay consentimientos registrados para este estudiante
            </div>
        </mat-card-content>
    </mat-card>
</div>